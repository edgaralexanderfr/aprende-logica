<?php    require_once '../php/config.php';  require_once '../system/function.valpost.php';    header('Content-Type: application/json');    try {    if (!valpost($_POST, array('password', 'confirmPassword', 'oldPassword'))) {      throw new Exception('Parámetros inválidos.', 1);    }        require_once '../system/class.Session.php';        $session = Session :: get();        if ($session == null) {      throw new Exception('Debes iniciar sesión para poder cambiar tu contraseña.', 2);    }        $oldPasswordHash = sha1($_POST['oldPassword'] . $session->salt);        if ($oldPasswordHash != $session->passwordHash) {      throw new Exception('Tu contraseña actual es incorrecta.', 3);    }        $session->setPassword($_POST['password'], $_POST['confirmPassword']);        require_once '../php/connection.php';        if (!$mysqli) {      throw new Exception('Base de datos no disponible.', 4);    }        User :: $mysqli = $mysqli;    $session->updatePassword();    Session :: update();        echo json_encode(array(      'errno' => 0,       'message' => utf8_encode('Contraseña actualizada correctamente.')    ));  } catch (Exception $ex1) {    echo json_encode(array(      'errno' => 1,       'message' => utf8_encode($ex1->getMessage())    ));  }